name: Java Plugin Snapshot (Reusable)

on:
  workflow_call:
    inputs:
      java:
        type: string
        default: '21'
      project_slug:
        type: string
        default: ''
    secrets:
      R2_ACCOUNT_ID: { required: true }
      R2_ACCESS_KEY_ID: { required: true }
      R2_SECRET_ACCESS_KEY: { required: true }
      R2_BUCKET: { required: true }
      R2_PUBLIC_BASE: { required: true }
      DISCORD_WEBHOOK: { required: false }

jobs:
  snapshot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PROJECT_SLUG: >-
        ${{ inputs.project_slug != '' && inputs.project_slug || github.event.repository.name }}
      R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Make wrapper executable
        run: chmod +x ./gradlew

      - name: Determine snapshot version
        id: snap
        shell: bash
        run: |
          set -euo pipefail

          if git tag --list 'v[0-9]*' | grep -q .; then
            BASE="$(git describe --tags --match 'v[0-9]*' --abbrev=0 | sed 's/^v//')"
          else
            BASE="0.0.0"
          fi

          INDEX_URL="${{ secrets.R2_PUBLIC_BASE }}/${{ env.PROJECT_SLUG }}/snapshots/index.json"
          NEXT_R=1
          if curl -fsSL "$INDEX_URL" >/tmp/index.json 2>/dev/null; then
            MAX_R=$(jq -r --arg base "$BASE" '
              (.versions // [])[]
              | .version
              | select(startswith($base + "-R"))
              | capture("^(?<b>[0-9]+\\.[0-9]+\\.[0-9]+)-R(?<r>[0-9]+)-SNAPSHOT$")
              | .r
            ' /tmp/index.json | sort -n | tail -n1)
            if [ -n "${MAX_R:-}" ]; then
              NEXT_R=$((MAX_R + 1))
            fi
          fi

          SNAP="${BASE}-R${NEXT_R}-SNAPSHOT"
          echo "Base: $BASE"
          echo "Next R: $NEXT_R"
          echo "Computed snapshot: $SNAP"

          echo "BASE=$BASE"   >> "$GITHUB_OUTPUT"
          echo "RNUM=$NEXT_R" >> "$GITHUB_OUTPUT"
          echo "VERSION=$SNAP" >> "$GITHUB_OUTPUT"

      - name: Derive Minecraft version
        id: mc
        run: |
          MC="$(./gradlew -q printMinecraftVersion)"
          echo "MC_VERSION=$MC" >> "$GITHUB_OUTPUT"

      - name: Build snapshot jar
        run: ./gradlew clean shadowJar -Pversion=${{ steps.snap.outputs.VERSION }} --stacktrace

      - name: Find artifact
        id: artifact
        run: |
          FILE=$(ls build/libs/*.jar | head -n 1)
          echo "FILE=$FILE" >> $GITHUB_OUTPUT
          echo "VER=$(basename "$FILE")" >> $GITHUB_OUTPUT

      - name: SHA256
        run: sha256sum "${{ steps.artifact.outputs.FILE }}" | awk '{print $1}' > "${{ steps.artifact.outputs.FILE }}.sha256"

      - name: Install AWS CLI + jq
        run: |
          pipx install awscli
          sudo apt-get update -y && sudo apt-get install -y jq curl

      - name: Upload snapshot to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
        run: |
          CHAN=snapshots
          VER="${{ steps.snap.outputs.VERSION }}"
          MCVER="${{ steps.mc.outputs.MC_VERSION }}"
          FILE="${{ steps.artifact.outputs.FILE }}"
          BASE="${{ secrets.R2_PUBLIC_BASE }}/${PROJECT_SLUG}/${CHAN}/${VER}"

          cat > manifest.json <<JSON
          {
            "project": "${PROJECT_SLUG}",
            "channel": "snapshot",
            "version": "${VER}",
            "minecraft": "${MCVER}",
            "artifact": "${VER}",
            "download": "${BASE}/${VER}",
            "checksum": "${BASE}/${VER}.sha256",
            "timestamp": "${{ github.event.head_commit.timestamp }}"
          }
          JSON

          aws s3 cp "$FILE"          "s3://${{ secrets.R2_BUCKET }}/${PROJECT_SLUG}/${CHAN}/${VER}/${VER}"         --endpoint-url "$R2_ENDPOINT"
          aws s3 cp "${FILE}.sha256" "s3://${{ secrets.R2_BUCKET }}/${PROJECT_SLUG}/${CHAN}/${VER}/${VER}.sha256"  --endpoint-url "$R2_ENDPOINT"
          aws s3 cp manifest.json    "s3://${{ secrets.R2_BUCKET }}/${PROJECT_SLUG}/${CHAN}/${VER}/manifest.json"   --endpoint-url "$R2_ENDPOINT"

          # latest.json for snapshots
          cat > latest.json <<JSON
          { "version": "${VER}",
            "manifest": "${{ secrets.R2_PUBLIC_BASE }}/${PROJECT_SLUG}/${CHAN}/${VER}/manifest.json" }
          JSON
          aws s3 cp latest.json "s3://${{ secrets.R2_BUCKET }}/${PROJECT_SLUG}/${CHAN}/latest.json" --endpoint-url "$R2_ENDPOINT"

          # build index.json (snapshot list)
          aws s3api list-objects-v2 --bucket "${{ secrets.R2_BUCKET }}" \
            --prefix "${PROJECT_SLUG}/${CHAN}/" --delimiter "/" \
            --endpoint-url "$R2_ENDPOINT" > list.json

          VERS=$(jq -r '.CommonPrefixes[].Prefix' list.json | sed "s#${PROJECT_SLUG}/${CHAN}/##; s#/\$##" | grep -v '^latest$' || true)

          echo '{ "project": "'${PROJECT_SLUG}'", "channel": "snapshot", "versions": [' > index.json
          FIRST=1
          for v in $VERS; do
            MAN="${{ secrets.R2_PUBLIC_BASE }}/${PROJECT_SLUG}/${CHAN}/${v}/manifest.json"
            TIM=$(curl -fsSL "$MAN" | jq -r '.timestamp // empty' || true)
            MC=$(curl -fsSL "$MAN" | jq -r '.minecraft // empty' || true)
            [ $FIRST -eq 0 ] && echo ',' >> index.json
            EXTRA=""
            [ -n "$TIM" ] && EXTRA="$EXTRA, \"timestamp\": \"$TIM\""
            [ -n "$MC" ]  && EXTRA="$EXTRA, \"minecraft\": \"$MC\""

            echo "{ \"version\": \"$v\", \"manifest\": \"$MAN\"$EXTRA }" >> index.json
            FIRST=0
          done
          echo '] }' >> index.json
          aws s3 cp index.json "s3://${{ secrets.R2_BUCKET }}/${PROJECT_SLUG}/${CHAN}/index.json" --endpoint-url "$R2_ENDPOINT"

      - name: Discord notify
        if: always()
        run: |
          [ -z "${{ secrets.DISCORD_WEBHOOK }}" ] && exit 0
          curl -H "Content-Type: application/json" -X POST \
            -d "{\"content\":\"⚙️ Snapshot build: \`${{ steps.snap.outputs.VERSION }}\` for project \`${{ env.PROJECT_SLUG }}\`\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"
