name: Java Plugin Snapshot (Reusable)

on:
  workflow_call:
    inputs:
      java:
        type: string
        default: '21'
      project_slug:
        type: string
        default: '${{ github.event.repository.name }}'
    secrets:
      R2_ACCOUNT_ID: { required: true }
      R2_ACCESS_KEY_ID: { required: true }
      R2_SECRET_ACCESS_KEY: { required: true }
      R2_BUCKET: { required: true }
      R2_PUBLIC_BASE: { required: true }
      DISCORD_WEBHOOK: { required: false }

jobs:
  snapshot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      PROJECT_SLUG: ${{ inputs.project_slug }}
      R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
    steps:
      - name: Checkout (internal)
        shell: bash
        env:
          REF: ${{ github.ref }}
          REF_NAME: ${{ github.ref_name }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          git init .
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git fetch --prune --tags origin "+refs/heads/*:refs/remotes/origin/*"
          git checkout -B "${REF_NAME}" "origin/${REF_NAME}" || git checkout "${REF}"

      - name: Install Java ${{ inputs.java }} + tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y openjdk-${{ inputs.java }}-jdk jq curl python3-pip
          pip3 install --user awscli
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          aws --version
          java -version
          jq --version

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Compute snapshot version
        id: ver
        run: |
          set -euo pipefail
          DATE=$(date -u +%Y%m%d)
          SHORTSHA=$(git rev-parse --short HEAD)
          BASE=$(./gradlew -q currentVersion | sed 's/-SNAPSHOT//')
          echo "SNAPSHOT=${BASE}-dev.${DATE}+${SHORTSHA}" >> $GITHUB_OUTPUT

      - name: Build shaded jar
        run: ./gradlew clean shadowJar -Pversion=${{ steps.ver.outputs.SNAPSHOT }} --stacktrace

      - name: Locate artifact and checksum
        id: artifact
        run: |
          set -euo pipefail
          FILE=$(ls build/libs/*-all.jar | head -n 1)
          echo "FILE=$FILE" >> $GITHUB_OUTPUT
          echo "NAME=$(basename "$FILE")" >> $GITHUB_OUTPUT
          sha256sum "$FILE" | awk '{print $1}' > "${FILE}.sha256"

      - name: Upload snapshot to R2 + manifests
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
        run: |
          set -euo pipefail
          CHAN="snapshots"
          VER="${{ steps.ver.outputs.SNAPSHOT }}"
          NAME="${{ steps.artifact.outputs.NAME }}"
          FILE="${{ steps.artifact.outputs.FILE }}"
          BASE="${{ secrets.R2_PUBLIC_BASE }}/projects/${PROJECT_SLUG}/${CHAN}/${VER}"

          # per-version manifest
          cat > manifest.json <<JSON
          { "project": "${PROJECT_SLUG}", "channel": "snapshot", "version": "${VER}",
            "artifact": "${NAME}", "download": "${BASE}/${NAME}",
            "checksum": "${BASE}/${NAME}.sha256", "released": "${{ github.event.head_commit.timestamp }}" }
          JSON

          # uploads
          aws s3 cp "$FILE"           "s3://${{ secrets.R2_BUCKET }}/projects/${PROJECT_SLUG}/${CHAN}/${VER}/${NAME}"           --endpoint-url "$R2_ENDPOINT"
          aws s3 cp "${FILE}.sha256"  "s3://${{ secrets.R2_BUCKET }}/projects/${PROJECT_SLUG}/${CHAN}/${VER}/${NAME}.sha256"    --endpoint-url "$R2_ENDPOINT"
          aws s3 cp manifest.json     "s3://${{ secrets.R2_BUCKET }}/projects/${PROJECT_SLUG}/${CHAN}/${VER}/manifest.json"     --endpoint-url "$R2_ENDPOINT"

          # latest.json
          cat > latest.json <<JSON
          { "version": "${VER}",
            "manifest": "${{ secrets.R2_PUBLIC_BASE }}/projects/${PROJECT_SLUG}/${CHAN}/${VER}/manifest.json" }
          JSON
          aws s3 cp latest.json "s3://${{ secrets.R2_BUCKET }}/projects/${PROJECT_SLUG}/${CHAN}/latest.json" --endpoint-url "$R2_ENDPOINT"

          # index.json
          aws s3api list-objects-v2 --bucket "${{ secrets.R2_BUCKET }}" \
            --prefix "projects/${PROJECT_SLUG}/${CHAN}/" --delimiter "/" \
            --endpoint-url "$R2_ENDPOINT" > list.json
          VERS=$(jq -r '.CommonPrefixes[].Prefix' list.json | sed "s#projects/${PROJECT_SLUG}/${CHAN}/##; s#/\$##" | grep -v '^latest$' || true)

          echo '{ "project": "'${PROJECT_SLUG}'", "channel": "snapshot", "versions": [' > index.json
          FIRST=1
          for v in $VERS; do
            MAN="${{ secrets.R2_PUBLIC_BASE }}/projects/${PROJECT_SLUG}/${CHAN}/${v}/manifest.json"
            REL=$(curl -fsSL "$MAN" | jq -r '.released // empty' || true)
            [ $FIRST -eq 0 ] && echo ',' >> index.json
            echo '{ "version": "'$v'", "manifest": "'$MAN'"'$( [ -n "$REL" ] && echo ', "released": "'$REL'"' )'}' >> index.json
            FIRST=0
          done
          echo '] }' >> index.json
          aws s3 cp index.json "s3://${{ secrets.R2_BUCKET }}/projects/${PROJECT_SLUG}/${CHAN}/index.json" --endpoint-url "$R2_ENDPOINT"

      - name: Discord notify
        if: always()
        run: |
          [ -z "${{ secrets.DISCORD_WEBHOOK }}" ] && exit 0
          STATUS="${{ job.status }}"
          VER="${{ steps.ver.outputs.SNAPSHOT }}"
          curl -H "Content-Type: application/json" -X POST \
            -d "{\"content\":\"ðŸ“¦ Snapshot **${STATUS}**\\nProject: \`${{ env.PROJECT_SLUG }}\`\\nVersion: \`${VER}\`\\nRepo: ${{ github.repository }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"
