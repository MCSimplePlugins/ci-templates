name: Java Plugin CI (Reusable)

on:
  workflow_call:
    inputs:
      java:
        type: string
        default: '21'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout (internal)
        shell: bash
        env:
          REF: ${{ github.ref }}
          REF_NAME: ${{ github.ref_name }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          git init .
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          # Fetch full history + tags (helps version plugins later)
          git fetch --prune --tags origin "+refs/heads/*:refs/remotes/origin/*"
          # Check out the ref the workflow was triggered on
          git checkout -B "${REF_NAME}" "origin/${REF_NAME}" || git checkout -B "${REF_NAME}" "${REF##refs/heads/}" || git checkout "${REF}"

      - name: Install Java ${{ inputs.java }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y openjdk-${{ inputs.java }}-jdk || {
            # Fallback for Adoptium if Ubuntu package name differs
            sudo apt-get install -y wget gnupg
            wget -qO - https://packages.adoptium.net/artifactory/api/gpg/key/public | sudo apt-key add -
            echo "deb https://packages.adoptium.net/artifactory/deb stable main" | sudo tee /etc/apt/sources.list.d/adoptium.list
            sudo apt-get update -y
            sudo apt-get install -y temurin-${{ inputs.java }}-jdk
          }
          java -version

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Build
        run: ./gradlew clean build --stacktrace
